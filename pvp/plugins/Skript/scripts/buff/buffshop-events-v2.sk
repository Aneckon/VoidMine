# ============================================
# BUFF SHOP EVENTS v2.0 - –û–±—Ä–æ–±–∫–∞ –∫–ª—ñ–∫—ñ–≤
# ============================================

on inventory click:
	set {_inv} to name of event-inventory
	
	# ===== –ì–û–õ–û–í–ù–ï –ú–ï–ù–Æ –ú–ê–ì–ê–ó–ò–ù–£ =====
	if {_inv} is "&cüõí –ú–∞–≥–∞–∑–∏–Ω –ë–∞—Ñ—Ñ–æ–≤":
		cancel event
		set {_slot} to index of event-slot
		
		if {_slot} is 20:
			bsPlayClick(player)
			close player's inventory
			wait 2 ticks
			openBuffCategory(player, "speed")
		else if {_slot} is 22:
			bsPlayClick(player)
			close player's inventory
			wait 2 ticks
			openBuffCategory(player, "defense")
		else if {_slot} is 24:
			bsPlayClick(player)
			close player's inventory
			wait 2 ticks
			openBuffCategory(player, "kill")
		else if {_slot} is 40:
			bsPlayClick(player)
			close player's inventory
		stop
	
	# ===== –ú–ï–ù–Æ –ö–ê–¢–ï–ì–û–†–Ü–ô (–ü–û–ö–£–ü–ö–ê) =====
	if {_inv} is {buff::category::speed::name}:
		cancel event
		set {_slot} to index of event-slot
		
		if {_slot} is 40:
			bsPlayClick(player)
			close player's inventory
			wait 2 ticks
			openBuffShopMain(player)
		else if {_slot} is 20:
			purchaseBuff(player, {buff::list::speed::1})
		else if {_slot} is 22:
			purchaseBuff(player, {buff::list::speed::2})
		else if {_slot} is 24:
			purchaseBuff(player, {buff::list::speed::3})
		stop
	
	if {_inv} is {buff::category::defense::name}:
		cancel event
		set {_slot} to index of event-slot
		
		if {_slot} is 40:
			bsPlayClick(player)
			close player's inventory
			wait 2 ticks
			openBuffShopMain(player)
		else if {_slot} is 20:
			purchaseBuff(player, {buff::list::defense::1})
		else if {_slot} is 22:
			purchaseBuff(player, {buff::list::defense::2})
		else if {_slot} is 24:
			purchaseBuff(player, {buff::list::defense::3})
		stop
	
	if {_inv} is {buff::category::kill::name}:
		cancel event
		set {_slot} to index of event-slot
		
		if {_slot} is 40:
			bsPlayClick(player)
			close player's inventory
			wait 2 ticks
			openBuffShopMain(player)
		else if {_slot} is 20:
			purchaseBuff(player, {buff::list::kill::1})
		else if {_slot} is 22:
			purchaseBuff(player, {buff::list::kill::2})
		stop
	
	# ===== –ú–ï–ù–Æ "–ú–û–ò –ë–ê–§–§–´" =====
	if {_inv} is "&cüíº –ú–æ–∏ –ë–∞—Ñ—Ñ—ã":
		cancel event
		set {_slot} to index of event-slot
		
		if {_slot} is 40:
			bsPlayClick(player)
			close player's inventory
			wait 2 ticks
			openSelectBuffMenu(player)
		stop
	
	# ===== –ú–ï–ù–Æ "–ê–ö–¢–ò–í–ù–´–ï –ë–ê–§–§–´" =====
	if {_inv} is "&c‚ö° –ê–∫—Ç–∏–≤–Ω—ã–µ –ë–∞—Ñ—Ñ—ã":
		cancel event
		set {_slot} to index of event-slot
		
		if {_slot} is 20:
			handleBuffSlotClick(player, "speed")
		else if {_slot} is 22:
			handleBuffSlotClick(player, "defense")
		else if {_slot} is 24:
			handleBuffSlotClick(player, "kill")
		else if {_slot} is 40:
			bsPlayClick(player)
			close player's inventory
		stop
	
	# ===== –ú–ï–ù–Æ –í–ò–ë–û–†–£ –ö–û–ù–ö–†–ï–¢–ù–û–ì–û –ë–ê–§–ê =====
	if {_inv} contains "&c‚ö° –í—ã–±–æ—Ä:":
		cancel event
		set {_slot} to index of event-slot
		
		# –í–∏–∑–Ω–∞—á–∏—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é –∑ –Ω–∞–∑–≤–∏ —ñ–Ω–≤–µ–Ω—Ç–∞—Ä—è
		set {_category} to "none"
		if {_inv} contains "–°–∫–æ—Ä–æ—Å—Ç–∏":
			set {_category} to "speed"
		else if {_inv} contains "–ó–∞—â–∏—Ç—ã":
			set {_category} to "defense"
		else if {_inv} contains "–£–±–∏–π—Å—Ç–≤–∞":
			set {_category} to "kill"
		
		if {_slot} is 22:
			bsPlayClick(player)
			close player's inventory
			wait 2 ticks
			openSelectBuffMenu(player)
		else if {_slot} is 16:
			handleRemoveBuff(player, {_category})
		else if {_slot} >= 10:
			if {_slot} <= 15:
				handleBuffSelection(player, {_category}, {_slot})
		stop

# ===== –û–ë–†–û–ë–ö–ê –ö–õ–Ü–ö–Ü–í –ù–ê –°–õ–û–¢–ò =====

function handleBuffSlotClick(p: player, category: text):
	set {_unlockedBuffs::*} to getUnlockedBuffsInCategory({_p}, {_category})
	
	if size of {_unlockedBuffs::*} is 0:
		send "&c‚úñ –£ –≤–∞—Å –Ω–µ—Ç –∫—É–ø–ª–µ–Ω–Ω—ã—Ö –±–∞—Ñ—Ñ–æ–≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏!" to {_p}
		send "&8‚ùñ &7–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ &f/buffshop &7—á—Ç–æ–±—ã –∫—É–ø–∏—Ç—å" to {_p}
		bsPlayError({_p})
		stop
	
	# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ —Å–ª–æ—Ç –≤–∂–µ –∑–∞–π–Ω—è—Ç–∏–π
	set {_isSlotUsed} to false
	if {buff.active.slot.%{_p}%.%{_category}%} is set:
		set {_isSlotUsed} to true
	
	# –Ø–∫—â–æ —Å–ª–æ—Ç –ù–ï –∑–∞–π–Ω—è—Ç–∏–π, –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ª—ñ–º—ñ—Ç
	if {_isSlotUsed} is false:
		set {_maxSlots} to getMaxBuffSlots({_p})
		set {_usedSlots} to getActiveBuffSlotsCount({_p})
		
		if {_usedSlots} >= {_maxSlots}:
			send " " to {_p}
			send "&c‚úñ –õ–∏–º–∏—Ç —Å–ª–æ—Ç–æ–≤ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç!" to {_p}
			send "&8‚ùñ &7–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: &f%{_usedSlots}%&8/&f%{_maxSlots}%" to {_p}
			
			if {_maxSlots} is 1:
				send "&8‚§∑ &7–ù—É–∂–µ–Ω &f–ë—É–Ω—Ç &7–¥–ª—è 2 —Å–ª–æ—Ç–æ–≤" to {_p}
			else if {_maxSlots} is 2:
				send "&8‚§∑ &7–ù—É–∂–µ–Ω &f–ì–Ω–µ–≤ &7–¥–ª—è 3 —Å–ª–æ—Ç–æ–≤" to {_p}
			
			send " " to {_p}
			bsPlayError({_p})
			stop
	
	bsPlayClick({_p})
	close {_p}'s inventory
	wait 2 ticks
	openBuffSelectionMenu({_p}, {_category})

# ===== –û–ë–†–û–ë–ö–ê –í–ò–ë–û–†–£ –ë–ê–§–ê =====

function handleBuffSelection(p: player, category: text, slot: number):
	set {_unlockedBuffs::*} to getUnlockedBuffsInCategory({_p}, {_category})
	set {_index} to {_slot} - 9
	
	if {_index} > size of {_unlockedBuffs::*}:
		stop
	
	set {_selectedBuff} to {_unlockedBuffs::%{_index}%}
	
	# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ –≤–∂–µ –∞–∫—Ç–∏–≤–Ω–∏–π
	if isBuffActive({_p}, {_selectedBuff}) is true:
		send "&c‚úñ –≠—Ç–æ—Ç –±–∞—Ñ—Ñ —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω!" to {_p}
		bsPlayError({_p})
		stop
	
	# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ª—ñ–º—ñ—Ç —Å–ª–æ—Ç—ñ–≤ –ü–ï–†–ï–î –∞–∫—Ç–∏–≤–∞—Ü—ñ—î—é
	if {buff.active.slot.%{_p}%.%{_category}%} is not set:
		set {_maxSlots} to getMaxBuffSlots({_p})
		set {_usedSlots} to getActiveBuffSlotsCount({_p})
		
		if {_usedSlots} >= {_maxSlots}:
			send " " to {_p}
			send "&c‚úñ –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç —Å–ª–æ—Ç–æ–≤!" to {_p}
			send "&8‚ùñ &7–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: &f%{_usedSlots}%&8/&f%{_maxSlots}%" to {_p}
			
			if {_maxSlots} is 1:
				send "&8‚§∑ &7–ù—É–∂–µ–Ω &f–ë—É–Ω—Ç &7–¥–ª—è 2 —Å–ª–æ—Ç–æ–≤" to {_p}
			else if {_maxSlots} is 2:
				send "&8‚§∑ &7–ù—É–∂–µ–Ω &f–ì–Ω–µ–≤ &7–¥–ª—è 3 —Å–ª–æ—Ç–æ–≤" to {_p}
			
			send " " to {_p}
			bsPlayError({_p})
			stop
	
	# –ê–∫—Ç–∏–≤—É–≤–∞—Ç–∏ –±–∞—Ñ
	set {_result} to activateBuff({_p}, {_selectedBuff})
	
	if {_result} is true:
		set {_name} to getBuffName({_selectedBuff})
		send "&c‚úî –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω: %{_name}%" to {_p}
		bsPlaySuccess({_p})
		
		wait 5 ticks
		close {_p}'s inventory
		wait 2 ticks
		openSelectBuffMenu({_p})
	else:
		send "&c‚úñ –û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏!" to {_p}
		bsPlayError({_p})

# ===== –û–ë–†–û–ë–ö–ê –ó–ù–Ø–¢–¢–Ø –ë–ê–§–ê =====

function handleRemoveBuff(p: player, category: text):
	if {buff.active.slot.%{_p}%.%{_category}%} is not set:
		send "&c‚úñ –í —ç—Ç–æ–º —Å–ª–æ—Ç–µ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–∞—Ñ—Ñ–∞!" to {_p}
		bsPlayError({_p})
		stop
	
	deactivateBuff({_p}, {_category})
	
	send "&c‚úî –ë–∞—Ñ—Ñ —Å–Ω—è—Ç!" to {_p}
	bsPlaySuccess({_p})
	
	wait 5 ticks
	close {_p}'s inventory
	wait 2 ticks
	openSelectBuffMenu({_p})
